<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blackboard Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'SF Mono', 'Menlo', 'Consolas', monospace;
      background: #0d1117;
      color: #c9d1d9;
      padding: 24px;
      font-size: 13px;
      line-height: 1.5;
    }
    h1 { color: #58a6ff; font-size: 18px; margin-bottom: 4px; }
    .subtitle { color: #8b949e; font-size: 12px; margin-bottom: 24px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 16px;
    }
    .card h2 {
      color: #58a6ff;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
      border-bottom: 1px solid #21262d;
      padding-bottom: 8px;
    }
    .stat-row { display: flex; justify-content: space-between; padding: 4px 0; }
    .stat-label { color: #8b949e; }
    .stat-value { color: #c9d1d9; font-weight: 600; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th {
      text-align: left;
      color: #8b949e;
      font-weight: 600;
      padding: 6px 8px;
      border-bottom: 1px solid #30363d;
      text-transform: uppercase;
      font-size: 11px;
    }
    td { padding: 6px 8px; border-bottom: 1px solid #21262d; }
    .badge {
      display: inline-block;
      padding: 1px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    .badge-active { background: #0d419d; color: #58a6ff; }
    .badge-idle { background: #272e18; color: #7ee787; }
    .badge-completed { background: #1c2128; color: #8b949e; }
    .badge-stale { background: #3d1c00; color: #d29922; }
    .badge-available { background: #0d419d; color: #58a6ff; }
    .badge-claimed { background: #272e18; color: #7ee787; }
    .badge-blocked { background: #490202; color: #f85149; }
    .empty { color: #484f58; font-style: italic; padding: 12px 0; }
    .event-line { padding: 3px 0; color: #8b949e; }
    .event-type { color: #d2a8ff; }
    .event-summary { color: #c9d1d9; }
    .refresh-info { color: #484f58; font-size: 11px; text-align: right; }
    .truncate { max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Agent row clickable */
    tr.agent-row { cursor: pointer; transition: background 0.15s; }
    tr.agent-row:hover { background: #1c2128; }
    tr.agent-row.selected { background: #1c2128; border-left: 2px solid #58a6ff; }
    tr.agent-row.has-log td:first-child::before {
      content: '';
      display: inline-block;
      width: 6px; height: 6px;
      border-radius: 50%;
      background: #58a6ff;
      margin-right: 6px;
      vertical-align: middle;
    }

    /* Log viewer panel */
    .log-panel {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      margin-top: 16px;
      display: none;
    }
    .log-panel.visible { display: block; }
    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      border-bottom: 1px solid #21262d;
      background: #161b22;
      border-radius: 6px 6px 0 0;
    }
    .log-header h3 {
      color: #58a6ff;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .log-close {
      background: none;
      border: 1px solid #30363d;
      color: #8b949e;
      cursor: pointer;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-family: inherit;
    }
    .log-close:hover { color: #c9d1d9; border-color: #484f58; }
    .log-content {
      padding: 12px 16px;
      max-height: 500px;
      overflow-y: auto;
      font-size: 11px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      color: #8b949e;
    }
    .log-content .stderr { color: #f85149; }
    .log-streaming {
      display: inline-block;
      width: 8px; height: 8px;
      border-radius: 50%;
      background: #7ee787;
      margin-left: 8px;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    .log-no-content { color: #484f58; font-style: italic; }
  </style>
</head>
<body>
  <h1>Blackboard Dashboard</h1>
  <div class="subtitle">Local Agent Coordination — <span id="db-path">loading...</span> (<span id="db-size">...</span>)</div>

  <div class="grid">
    <div class="card">
      <h2>Overview</h2>
      <div id="overview">
        <div class="stat-row"><span class="stat-label">Agents</span><span class="stat-value" id="agent-stats">--</span></div>
        <div class="stat-row"><span class="stat-label">Projects</span><span class="stat-value" id="project-count">--</span></div>
        <div class="stat-row"><span class="stat-label">Work Items</span><span class="stat-value" id="work-stats">--</span></div>
        <div class="stat-row"><span class="stat-label">Events (24h)</span><span class="stat-value" id="event-count">--</span></div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Agents</h2>
      <div id="agents-container"><span class="empty">Loading...</span></div>
      <div class="log-panel" id="log-panel">
        <div class="log-header">
          <h3>
            Agent Log: <span id="log-agent-name">--</span>
            <span id="log-streaming-indicator" class="log-streaming" style="display:none;"></span>
          </h3>
          <button class="log-close" onclick="closeLogPanel()">Close</button>
        </div>
        <div class="log-content" id="log-content">
          <span class="log-no-content">Loading log...</span>
        </div>
      </div>
    </div>
    <div class="card">
      <h2>Work Items</h2>
      <div id="work-container"><span class="empty">Loading...</span></div>
    </div>
  </div>

  <div class="card" style="margin-bottom: 16px;">
    <h2>Recent Events</h2>
    <div id="events-container"><span class="empty">Loading...</span></div>
  </div>

  <div class="refresh-info">Auto-refreshes every 5s — <span id="last-update">never</span></div>

  <script>
    const API = '';

    function badge(status) {
      const cls = `badge badge-${status}`;
      return `<span class="${cls}">${status}</span>`;
    }

    function relTime(iso) {
      const ms = Date.now() - new Date(iso).getTime();
      const s = Math.floor(ms / 1000);
      if (s < 60) return 'just now';
      const m = Math.floor(s / 60);
      if (m < 60) return m + 'm ago';
      const h = Math.floor(m / 60);
      if (h < 24) return h + 'h ago';
      return Math.floor(h / 24) + 'd ago';
    }

    function truncate(str, len) {
      if (!str) return '--';
      return str.length > len ? str.slice(0, len) + '...' : str;
    }

    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    async function fetchStatus() {
      try {
        const res = await fetch(API + '/api/status');
        const data = await res.json();

        document.getElementById('db-path').textContent = data.database || '--';
        document.getElementById('db-size').textContent = data.database_size || '--';

        const a = data.agents || {};
        document.getElementById('agent-stats').textContent =
          `${a.active || 0} active, ${a.idle || 0} idle, ${a.stale || 0} stale`;

        document.getElementById('project-count').textContent = data.projects || 0;

        const w = data.work_items || {};
        document.getElementById('work-stats').textContent =
          `${w.claimed || 0} claimed, ${w.available || 0} avail, ${w.blocked || 0} blocked`;

        document.getElementById('event-count').textContent = data.events_24h || 0;
      } catch (e) {
        document.getElementById('agent-stats').textContent = 'Error';
      }
    }

    // ─── Agent list with log viewer ─────────────────────────────────

    let currentAgents = [];
    let selectedAgentId = null;
    let logPollInterval = null;

    function hasLogMetadata(agent) {
      if (!agent.metadata) return false;
      try {
        const meta = JSON.parse(agent.metadata);
        return !!meta.logPath;
      } catch { return false; }
    }

    async function fetchAgents() {
      try {
        const res = await fetch(API + '/api/agents?all=true');
        const data = await res.json();
        const el = document.getElementById('agents-container');
        currentAgents = data.items || [];

        // Filter: show dispatch agents (have metadata with logPath) and active/idle agents
        const dispatchAgents = currentAgents.filter(a =>
          hasLogMetadata(a) || a.status === 'active' || a.status === 'idle'
        );

        if (dispatchAgents.length === 0) {
          el.innerHTML = '<span class="empty">No agents.</span>';
          return;
        }

        let html = '<table><tr><th>Name</th><th>Status</th><th>Project</th><th>Work</th><th>Last Seen</th></tr>';
        for (const a of dispatchAgents) {
          const isSelected = a.session_id === selectedAgentId;
          const hasLog = hasLogMetadata(a);
          const classes = ['agent-row'];
          if (isSelected) classes.push('selected');
          if (hasLog) classes.push('has-log');

          html += `<tr class="${classes.join(' ')}" onclick="selectAgent('${a.session_id}')" title="${hasLog ? 'Click to view log' : 'No log available'}">
            <td>${a.agent_name}</td>
            <td>${badge(a.status)}</td>
            <td>${a.project || '--'}</td>
            <td class="truncate">${truncate(a.current_work, 40)}</td>
            <td>${relTime(a.last_seen_at)}</td>
          </tr>`;
        }
        html += '</table>';
        el.innerHTML = html;
      } catch (e) {
        document.getElementById('agents-container').innerHTML = '<span class="empty">Error loading agents.</span>';
      }
    }

    function selectAgent(sessionId) {
      if (selectedAgentId === sessionId) {
        closeLogPanel();
        return;
      }

      selectedAgentId = sessionId;
      const agent = currentAgents.find(a => a.session_id === sessionId);
      if (!agent) return;

      document.getElementById('log-agent-name').textContent =
        `${agent.agent_name} (${truncate(agent.session_id, 12)})`;
      document.getElementById('log-content').innerHTML = '<span class="log-no-content">Loading log...</span>';
      document.getElementById('log-panel').classList.add('visible');

      // Show streaming indicator if agent is active
      const isActive = agent.status === 'active' || agent.status === 'idle';
      document.getElementById('log-streaming-indicator').style.display = isActive ? 'inline-block' : 'none';

      // Fetch log immediately
      fetchAgentLog(sessionId);

      // Poll for updates if agent is active
      if (logPollInterval) clearInterval(logPollInterval);
      if (isActive) {
        logPollInterval = setInterval(() => fetchAgentLog(sessionId), 2000);
      }

      // Re-render agent list to show selection
      fetchAgents();
    }

    function closeLogPanel() {
      selectedAgentId = null;
      document.getElementById('log-panel').classList.remove('visible');
      if (logPollInterval) {
        clearInterval(logPollInterval);
        logPollInterval = null;
      }
      fetchAgents();
    }

    async function fetchAgentLog(sessionId) {
      try {
        const res = await fetch(API + '/api/agents/' + encodeURIComponent(sessionId) + '/log');
        const el = document.getElementById('log-content');

        if (!res.ok) {
          el.innerHTML = '<span class="log-no-content">No log file available for this agent.</span>';
          return;
        }

        const text = await res.text();
        const agentStatus = res.headers.get('X-Agent-Status');

        // Format the log content with stderr highlighting
        const formatted = escapeHtml(text)
          .split('\n')
          .map(line => {
            if (line.startsWith('[stderr]')) {
              return `<span class="stderr">${line}</span>`;
            }
            return line;
          })
          .join('\n');

        el.innerHTML = formatted || '<span class="log-no-content">Log file is empty.</span>';

        // Auto-scroll to bottom
        el.scrollTop = el.scrollHeight;

        // Update streaming indicator
        const isActive = agentStatus === 'active' || agentStatus === 'idle';
        document.getElementById('log-streaming-indicator').style.display = isActive ? 'inline-block' : 'none';

        // Stop polling if agent is no longer active
        if (!isActive && logPollInterval) {
          clearInterval(logPollInterval);
          logPollInterval = null;
        }
      } catch (e) {
        document.getElementById('log-content').innerHTML =
          '<span class="log-no-content">Error fetching log.</span>';
      }
    }

    async function fetchWork() {
      try {
        const res = await fetch(API + '/api/work?all=true');
        const data = await res.json();
        const el = document.getElementById('work-container');

        if (!data.items || data.items.length === 0) {
          el.innerHTML = '<span class="empty">No work items.</span>';
          return;
        }

        let html = '<table><tr><th>ID</th><th>Title</th><th>Status</th><th>Priority</th><th>Claimed</th></tr>';
        for (const w of data.items) {
          html += `<tr>
            <td>${w.item_id}</td>
            <td class="truncate">${truncate(w.title, 35)}</td>
            <td>${badge(w.status)}</td>
            <td>${w.priority}</td>
            <td>${w.claimed_by ? truncate(w.claimed_by, 12) : '--'}</td>
          </tr>`;
        }
        html += '</table>';
        el.innerHTML = html;
      } catch (e) {
        document.getElementById('work-container').innerHTML = '<span class="empty">Error loading work items.</span>';
      }
    }

    // SSE-powered events (with polling fallback)
    const MAX_EVENT_LINES = 30;
    let eventLines = [];
    let sseConnected = false;

    function renderEvents() {
      const el = document.getElementById('events-container');
      if (eventLines.length === 0) {
        el.innerHTML = '<span class="empty">No recent events.</span>';
        return;
      }
      el.innerHTML = eventLines.join('');
    }

    function addEventLine(e) {
      const actor = e.actor_id ? e.actor_id.slice(0, 12) : 'system';
      const line = `<div class="event-line">
        <span style="color:#484f58">${relTime(e.timestamp)}</span>
        <span class="event-type">${e.event_type}</span>
        [${actor}]
        <span class="event-summary">${e.summary}</span>
      </div>`;
      eventLines.unshift(line);
      if (eventLines.length > MAX_EVENT_LINES) eventLines.pop();
    }

    function connectSSE() {
      try {
        const es = new EventSource(API + '/api/events/stream');
        es.onopen = () => { sseConnected = true; };
        es.onmessage = (msg) => {
          try {
            const data = JSON.parse(msg.data);
            if (data.type === 'connected') return;
            addEventLine(data);
            renderEvents();
          } catch {}
        };
        es.onerror = () => {
          sseConnected = false;
          es.close();
          setTimeout(connectSSE, 5000);
        };
      } catch {
        sseConnected = false;
      }
    }

    async function fetchEvents() {
      if (sseConnected) return;
      try {
        const res = await fetch(API + '/api/events?limit=20');
        const data = await res.json();
        if (!data.items || data.items.length === 0) return;
        eventLines = [];
        for (const e of data.items.reverse()) { addEventLine(e); }
        renderEvents();
      } catch {}
    }

    async function refresh() {
      await Promise.all([fetchStatus(), fetchAgents(), fetchWork(), fetchEvents()]);
      document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
    }

    refresh();
    connectSSE();
    setInterval(refresh, 5000);
  </script>
</body>
</html>
