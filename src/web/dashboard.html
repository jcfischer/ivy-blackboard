<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blackboard Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'SF Mono', 'Menlo', 'Consolas', monospace;
      background: #0d1117;
      color: #c9d1d9;
      padding: 24px;
      font-size: 13px;
      line-height: 1.5;
    }
    h1 { color: #58a6ff; font-size: 18px; margin-bottom: 4px; }
    .subtitle { color: #8b949e; font-size: 12px; margin-bottom: 24px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 16px;
    }
    .card h2 {
      color: #58a6ff;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
      border-bottom: 1px solid #21262d;
      padding-bottom: 8px;
    }
    .stat-row { display: flex; justify-content: space-between; padding: 4px 0; }
    .stat-label { color: #8b949e; }
    .stat-value { color: #c9d1d9; font-weight: 600; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th {
      text-align: left;
      color: #8b949e;
      font-weight: 600;
      padding: 6px 8px;
      border-bottom: 1px solid #30363d;
      text-transform: uppercase;
      font-size: 11px;
    }
    td { padding: 6px 8px; border-bottom: 1px solid #21262d; }
    .badge {
      display: inline-block;
      padding: 1px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    .badge-active { background: #0d419d; color: #58a6ff; }
    .badge-idle { background: #272e18; color: #7ee787; }
    .badge-completed { background: #1c2128; color: #8b949e; }
    .badge-stale { background: #3d1c00; color: #d29922; }
    .badge-available { background: #0d419d; color: #58a6ff; }
    .badge-claimed { background: #272e18; color: #7ee787; }
    .badge-blocked { background: #490202; color: #f85149; }
    .empty { color: #484f58; font-style: italic; padding: 12px 0; }
    .event-line { padding: 3px 0; color: #8b949e; }
    .event-type { color: #d2a8ff; }
    .event-summary { color: #c9d1d9; }
    .refresh-info { color: #484f58; font-size: 11px; text-align: right; }
    .truncate { max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* Agent row clickable */
    tr.agent-row { cursor: pointer; transition: background 0.15s; }
    tr.agent-row:hover { background: #1c2128; }
    tr.agent-row.selected { background: #1c2128; border-left: 2px solid #58a6ff; }
    tr.agent-row.has-log td:first-child::before {
      content: '';
      display: inline-block;
      width: 6px; height: 6px;
      border-radius: 50%;
      background: #58a6ff;
      margin-right: 6px;
      vertical-align: middle;
    }

    /* Log viewer panel */
    .log-panel {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      margin-top: 16px;
      display: none;
    }
    .log-panel.visible { display: block; }
    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      border-bottom: 1px solid #21262d;
      background: #161b22;
      border-radius: 6px 6px 0 0;
    }
    .log-header h3 {
      color: #58a6ff;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .log-close {
      background: none;
      border: 1px solid #30363d;
      color: #8b949e;
      cursor: pointer;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-family: inherit;
    }
    .log-close:hover { color: #c9d1d9; border-color: #484f58; }
    .log-content {
      padding: 12px 16px;
      max-height: 500px;
      overflow-y: auto;
      font-size: 11px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      color: #8b949e;
    }
    .log-content .stderr { color: #f85149; }
    .log-streaming {
      display: inline-block;
      width: 8px; height: 8px;
      border-radius: 50%;
      background: #7ee787;
      margin-left: 8px;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    .log-no-content { color: #484f58; font-style: italic; }

    /* Project cards */
    .project-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; }
    .project-card {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 12px 14px;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
    }
    .project-card:hover { border-color: #58a6ff; background: #161b22; }
    .project-card.selected { border-color: #58a6ff; border-left: 3px solid #58a6ff; }
    .project-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .project-card-name { color: #58a6ff; font-weight: 600; font-size: 13px; }
    .project-card-id { color: #484f58; font-size: 11px; }
    .project-card-stats { display: flex; gap: 10px; font-size: 11px; color: #8b949e; }
    .project-card-stats .stat { display: flex; align-items: center; gap: 3px; }
    .project-card-stats .dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; }
    .project-card-stats .dot-active { background: #58a6ff; }
    .project-card-stats .dot-available { background: #7ee787; }
    .project-card-stats .dot-claimed { background: #d29922; }
    .project-card-stats .dot-completed { background: #8b949e; }
    .project-card-stats .dot-blocked { background: #f85149; }
    .project-card-meta { margin-top: 6px; font-size: 11px; color: #484f58; }
    .project-card-meta a { color: #58a6ff; text-decoration: none; }
    .project-card-meta a:hover { text-decoration: underline; }

    /* Project detail panel */
    .project-detail {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      margin-top: 16px;
      display: none;
    }
    .project-detail.visible { display: block; }
    .project-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid #21262d;
      background: #161b22;
      border-radius: 6px 6px 0 0;
    }
    .project-detail-header h3 {
      color: #58a6ff;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .project-detail-close {
      background: none;
      border: 1px solid #30363d;
      color: #8b949e;
      cursor: pointer;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-family: inherit;
    }
    .project-detail-close:hover { color: #c9d1d9; border-color: #484f58; }
    .project-detail-body { padding: 16px; }
    .project-detail-stats {
      display: flex;
      gap: 20px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #21262d;
    }
    .project-stat-box { text-align: center; }
    .project-stat-number { font-size: 20px; font-weight: 700; color: #c9d1d9; }
    .project-stat-label { font-size: 10px; color: #8b949e; text-transform: uppercase; letter-spacing: 0.5px; }
    .project-stat-number.rate { color: #7ee787; }
    .project-tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid #21262d;
      margin-bottom: 12px;
    }
    .project-tab {
      background: none;
      border: none;
      color: #8b949e;
      cursor: pointer;
      padding: 6px 14px;
      font-size: 12px;
      font-family: inherit;
      border-bottom: 2px solid transparent;
    }
    .project-tab:hover { color: #c9d1d9; }
    .project-tab.active { color: #58a6ff; border-bottom-color: #58a6ff; }
    .project-tab-content { display: none; }
    .project-tab-content.active { display: block; }
    .completion-bar { height: 4px; background: #21262d; border-radius: 2px; margin-top: 4px; overflow: hidden; }
    .completion-bar-fill { height: 100%; background: #7ee787; border-radius: 2px; transition: width 0.3s; }

    /* Work item tabs */
    .work-tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid #21262d;
      margin-bottom: 12px;
    }
    .work-tab {
      background: none;
      border: none;
      color: #8b949e;
      cursor: pointer;
      padding: 6px 14px;
      font-size: 12px;
      font-family: inherit;
      border-bottom: 2px solid transparent;
    }
    .work-tab:hover { color: #c9d1d9; }
    .work-tab.active { color: #58a6ff; border-bottom-color: #58a6ff; }
    .work-tab .tab-count {
      display: inline-block;
      background: #21262d;
      color: #8b949e;
      padding: 0 6px;
      border-radius: 10px;
      font-size: 10px;
      margin-left: 4px;
    }
    .work-tab.active .tab-count { background: #0d419d; color: #58a6ff; }


    /* Work item row clickable */
    tr.work-row { cursor: pointer; transition: background 0.15s; }
    tr.work-row:hover { background: #1c2128; }
    tr.work-row.selected { background: #1c2128; border-left: 2px solid #58a6ff; }

    /* Work detail panel */
    .work-detail-panel {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      margin-top: 16px;
      display: none;
    }
    .work-detail-panel.visible { display: block; }
    .work-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      border-bottom: 1px solid #21262d;
      background: #161b22;
      border-radius: 6px 6px 0 0;
    }
    .work-detail-header h3 {
      color: #58a6ff;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .work-detail-close {
      background: none;
      border: 1px solid #30363d;
      color: #8b949e;
      cursor: pointer;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-family: inherit;
    }
    .work-detail-close:hover { color: #c9d1d9; border-color: #484f58; }
    .work-detail-body { padding: 16px; }
    .work-detail-meta {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #21262d;
    }
    .work-meta-item { font-size: 11px; }
    .work-meta-label { color: #8b949e; margin-right: 4px; }
    .work-meta-value { color: #c9d1d9; }
    .work-detail-description {
      background: #161b22;
      border: 1px solid #21262d;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 12px;
      font-size: 12px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      color: #c9d1d9;
      max-height: 300px;
      overflow-y: auto;
    }
    .work-detail-section-title {
      color: #8b949e;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      margin-top: 12px;
    }
    .work-timeline-event {
      padding: 4px 0;
      font-size: 11px;
      color: #8b949e;
      display: flex;
      gap: 8px;
    }
    .work-timeline-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #30363d;
      margin-top: 4px;
      flex-shrink: 0;
    }
    .work-timeline-dot.work_created { background: #58a6ff; }
    .work-timeline-dot.work_claimed { background: #7ee787; }
    .work-timeline-dot.work_completed { background: #8b949e; }
    .work-timeline-dot.work_released { background: #d29922; }
    .work-timeline-dot.work_blocked { background: #f85149; }
    .work-agent-link {
      color: #58a6ff;
      cursor: pointer;
      text-decoration: none;
    }
    .work-agent-link:hover { text-decoration: underline; }
    .work-detail-metadata {
      background: #161b22;
      border: 1px solid #21262d;
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 11px;
      font-family: 'SF Mono', 'Menlo', monospace;
      color: #8b949e;
      white-space: pre-wrap;
      max-height: 150px;
      overflow-y: auto;
    }
    .duration-badge {
      display: inline-block;
      background: #272e18;
      color: #7ee787;
      padding: 0 6px;
      border-radius: 3px;
      font-size: 10px;
      margin-left: 4px;
    }
  </style>
</head>
<body>
  <h1>Blackboard Dashboard</h1>
  <div class="subtitle">Local Agent Coordination — <span id="db-path">loading...</span> (<span id="db-size">...</span>)</div>

  <div class="grid">
    <div class="card">
      <h2>Overview</h2>
      <div id="overview">
        <div class="stat-row"><span class="stat-label">Agents</span><span class="stat-value" id="agent-stats">--</span></div>
        <div class="stat-row"><span class="stat-label">Projects</span><span class="stat-value" id="project-count">--</span></div>
        <div class="stat-row"><span class="stat-label">Work Items</span><span class="stat-value" id="work-stats">--</span></div>
        <div class="stat-row"><span class="stat-label">Events (24h)</span><span class="stat-value" id="event-count">--</span></div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-bottom: 16px;">
    <h2>Projects</h2>
    <div id="projects-container"><span class="empty">Loading...</span></div>
    <div class="project-detail" id="project-detail">
      <div class="project-detail-header">
        <h3>Project: <span id="project-detail-name">--</span></h3>
        <button class="project-detail-close" onclick="closeProjectDetail()">Close</button>
      </div>
      <div class="project-detail-body">
        <div class="project-detail-stats" id="project-detail-stats"></div>
        <div class="project-tabs" id="project-tabs">
          <button class="project-tab active" onclick="switchProjectTab('agents')">Agents</button>
          <button class="project-tab" onclick="switchProjectTab('work')">Work Items</button>
          <button class="project-tab" onclick="switchProjectTab('events')">Events</button>
        </div>
        <div class="project-tab-content active" id="project-tab-agents"></div>
        <div class="project-tab-content" id="project-tab-work"></div>
        <div class="project-tab-content" id="project-tab-events"></div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Agents</h2>
      <div class="work-tabs" id="agent-tabs">
        <button class="work-tab active" onclick="switchAgentTab('running')">Running <span class="tab-count" id="agent-running-count">0</span></button>
        <button class="work-tab" onclick="switchAgentTab('completed')">Completed <span class="tab-count" id="agent-completed-count">0</span></button>
      </div>
      <div id="agents-container"><span class="empty">Loading...</span></div>
      <div class="log-panel" id="log-panel">
        <div class="log-header">
          <h3>
            Agent Log: <span id="log-agent-name">--</span>
            <span id="log-streaming-indicator" class="log-streaming" style="display:none;"></span>
          </h3>
          <button class="log-close" onclick="closeLogPanel()">Close</button>
        </div>
        <div class="log-content" id="log-content">
          <span class="log-no-content">Loading log...</span>
        </div>
      </div>
    </div>
    <div class="card">
      <h2>Work Items</h2>
      <div class="work-tabs" id="work-tabs">
        <button class="work-tab active" onclick="switchWorkTab('active')">Active <span class="tab-count" id="work-active-count">0</span></button>
        <button class="work-tab" onclick="switchWorkTab('history')">History <span class="tab-count" id="work-history-count">0</span></button>
      </div>
      <div id="work-container"><span class="empty">Loading...</span></div>
      <div class="work-detail-panel" id="work-detail-panel">
        <div class="work-detail-header">
          <h3>Work Item: <span id="work-detail-title">--</span></h3>
          <button class="work-detail-close" onclick="closeWorkDetail()">Close</button>
        </div>
        <div class="work-detail-body" id="work-detail-body">
          <span class="empty">Loading...</span>
        </div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-bottom: 16px;">
    <h2>Recent Events</h2>
    <div id="events-container"><span class="empty">Loading...</span></div>
  </div>

  <div class="refresh-info">Auto-refreshes <span id="poll-mode">every 5s</span> — <span id="last-update">never</span></div>

  <script>
    const API = '';

    // ─── SSE connection state & adaptive polling ──────────────────
    let sseConnected = false;
    let pollInterval = null;
    const POLL_FAST = 5000;   // when SSE disconnected
    const POLL_SLOW = 30000;  // when SSE connected

    // ─── Change detection: skip re-render when data unchanged ─────
    let lastAgentsJson = '';
    let lastWorkJson = '';
    let lastProjectsJson = '';

    function badge(status) {
      const cls = `badge badge-${status}`;
      return `<span class="${cls}">${status}</span>`;
    }

    function relTime(iso) {
      const ms = Date.now() - new Date(iso).getTime();
      const s = Math.floor(ms / 1000);
      if (s < 60) return 'just now';
      const m = Math.floor(s / 60);
      if (m < 60) return m + 'm ago';
      const h = Math.floor(m / 60);
      if (h < 24) return h + 'h ago';
      return Math.floor(h / 24) + 'd ago';
    }

    function truncate(str, len) {
      if (!str) return '--';
      return str.length > len ? str.slice(0, len) + '...' : str;
    }

    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    async function fetchStatus() {
      try {
        const res = await fetch(API + '/api/status');
        const data = await res.json();

        document.getElementById('db-path').textContent = data.database || '--';
        document.getElementById('db-size').textContent = data.database_size || '--';

        const a = data.agents || {};
        document.getElementById('agent-stats').textContent =
          `${a.active || 0} active, ${a.idle || 0} idle, ${a.stale || 0} stale`;

        document.getElementById('project-count').textContent = data.projects || 0;

        const w = data.work_items || {};
        document.getElementById('work-stats').textContent =
          `${w.claimed || 0} claimed, ${w.available || 0} avail, ${w.blocked || 0} blocked`;

        document.getElementById('event-count').textContent = data.events_24h || 0;
      } catch (e) {
        // Suppress transient errors when SSE is connected
        if (!sseConnected) {
          document.getElementById('agent-stats').textContent = 'Error';
        }
      }
    }

    // ─── Agent list with tabs and log viewer ────────────────────────

    let currentAgents = [];
    let currentAgentTab = 'running';
    let selectedAgentId = null;
    let logPollInterval = null;
    let elapsedInterval = null;

    function hasLogMetadata(agent) {
      if (!agent.metadata) return false;
      try {
        const meta = JSON.parse(agent.metadata);
        return !!meta.logPath;
      } catch { return false; }
    }

    function formatElapsed(isoStart) {
      const ms = Date.now() - new Date(isoStart).getTime();
      if (ms < 0) return '0s';
      const s = Math.floor(ms / 1000);
      if (s < 60) return s + 's';
      const m = Math.floor(s / 60);
      const rs = s % 60;
      if (m < 60) return m + 'm ' + rs + 's';
      const h = Math.floor(m / 60);
      const rm = m % 60;
      return h + 'h ' + rm + 'm';
    }

    async function fetchAgents() {
      try {
        const res = await fetch(API + '/api/agents?all=true');
        const data = await res.json();
        const items = data.items || [];
        // Change detection: skip re-render if data unchanged
        const json = JSON.stringify(items);
        if (json === lastAgentsJson) return;
        lastAgentsJson = json;
        currentAgents = items;
        renderAgents();
      } catch (e) {
        // Suppress transient errors when SSE is connected (data is still fresh)
        if (!sseConnected) {
          document.getElementById('agents-container').innerHTML = '<span class="empty">Error loading agents.</span>';
        }
      }
    }

    function renderAgents() {
      const el = document.getElementById('agents-container');

      // Filter: show dispatch agents (have metadata with logPath) and active/idle agents
      const dispatchAgents = currentAgents.filter(a =>
        hasLogMetadata(a) || a.status === 'active' || a.status === 'idle'
      );

      const running = dispatchAgents.filter(a => a.status === 'active' || a.status === 'idle');
      const completed = dispatchAgents.filter(a => a.status === 'completed' || a.status === 'stale');

      // Update tab counts
      document.getElementById('agent-running-count').textContent = running.length;
      document.getElementById('agent-completed-count').textContent = completed.length;

      const agents = currentAgentTab === 'running' ? running : completed;

      if (agents.length === 0) {
        const msg = currentAgentTab === 'running' ? 'No running agents.' : 'No completed agents.';
        el.innerHTML = '<span class="empty">' + msg + '</span>';
        stopElapsedTimer();
        return;
      }

      if (currentAgentTab === 'running') {
        let html = '<table><tr><th>Name</th><th>Status</th><th>Project</th><th>Work</th><th>Elapsed</th></tr>';
        for (const a of agents) {
          const isSelected = a.session_id === selectedAgentId;
          const hasLog = hasLogMetadata(a);
          const classes = ['agent-row'];
          if (isSelected) classes.push('selected');
          if (hasLog) classes.push('has-log');

          html += `<tr class="${classes.join(' ')}" onclick="selectAgent('${a.session_id}')" title="${hasLog ? 'Click to view log' : 'No log available'}">
            <td>${escapeHtml(a.agent_name)}</td>
            <td>${badge(a.status)}</td>
            <td>${a.project || '--'}</td>
            <td class="truncate">${truncate(a.current_work, 40)}</td>
            <td class="agent-elapsed" data-started="${a.started_at}">${formatElapsed(a.started_at)}</td>
          </tr>`;
        }
        html += '</table>';
        el.innerHTML = html;
        startElapsedTimer();
      } else {
        // Completed tab: sort by last_seen_at DESC (most recently completed first)
        const sorted = [...agents].sort((a, b) => new Date(b.last_seen_at).getTime() - new Date(a.last_seen_at).getTime());
        let html = '<table><tr><th>Name</th><th>Status</th><th>Project</th><th>Work</th><th>Duration</th><th>Completed</th></tr>';
        for (const a of sorted) {
          const isSelected = a.session_id === selectedAgentId;
          const hasLog = hasLogMetadata(a);
          const classes = ['agent-row'];
          if (isSelected) classes.push('selected');
          if (hasLog) classes.push('has-log');

          const duration = a.started_at && a.last_seen_at
            ? formatDuration(new Date(a.last_seen_at).getTime() - new Date(a.started_at).getTime())
            : '--';

          html += `<tr class="${classes.join(' ')}" onclick="selectAgent('${a.session_id}')" title="${hasLog ? 'Click to view log' : 'No log available'}">
            <td>${escapeHtml(a.agent_name)}</td>
            <td>${badge(a.status)}</td>
            <td>${a.project || '--'}</td>
            <td class="truncate">${truncate(a.current_work, 40)}</td>
            <td>${duration}</td>
            <td>${relTime(a.last_seen_at)}</td>
          </tr>`;
        }
        html += '</table>';
        el.innerHTML = html;
        stopElapsedTimer();
      }
    }

    function switchAgentTab(tab) {
      currentAgentTab = tab;
      document.querySelectorAll('#agent-tabs .work-tab').forEach(t => t.classList.remove('active'));
      document.querySelector('#agent-tabs .work-tab[onclick*="' + tab + '"]').classList.add('active');
      renderAgents();
    }

    function startElapsedTimer() {
      stopElapsedTimer();
      elapsedInterval = setInterval(() => {
        document.querySelectorAll('.agent-elapsed').forEach(el => {
          const started = el.getAttribute('data-started');
          if (started) el.textContent = formatElapsed(started);
        });
      }, 1000);
    }

    function stopElapsedTimer() {
      if (elapsedInterval) {
        clearInterval(elapsedInterval);
        elapsedInterval = null;
      }
    }

    function selectAgent(sessionId) {
      if (selectedAgentId === sessionId) {
        closeLogPanel();
        return;
      }

      selectedAgentId = sessionId;
      const agent = currentAgents.find(a => a.session_id === sessionId);
      if (!agent) return;

      document.getElementById('log-agent-name').textContent =
        `${agent.agent_name} (${truncate(agent.session_id, 12)})`;
      document.getElementById('log-content').innerHTML = '<span class="log-no-content">Loading log...</span>';
      document.getElementById('log-panel').classList.add('visible');

      // Show streaming indicator if agent is active
      const isActive = agent.status === 'active' || agent.status === 'idle';
      document.getElementById('log-streaming-indicator').style.display = isActive ? 'inline-block' : 'none';

      // Fetch full log immediately
      fetchAgentLog(sessionId, false);

      // Poll for updates if agent is active (tail only for efficiency)
      if (logPollInterval) clearInterval(logPollInterval);
      if (isActive) {
        logPollInterval = setInterval(() => fetchAgentLog(sessionId, true), 2000);
      }

      // Re-render agent list to show selection
      renderAgents();
    }

    function closeLogPanel() {
      selectedAgentId = null;
      document.getElementById('log-panel').classList.remove('visible');
      if (logPollInterval) {
        clearInterval(logPollInterval);
        logPollInterval = null;
      }
      renderAgents();
    }

    let lastLogSize = 0;

    async function fetchAgentLog(sessionId, tailOnly) {
      try {
        let url = API + '/api/agents/' + encodeURIComponent(sessionId) + '/log';
        if (tailOnly) {
          url += '?tail=200';
        }
        const res = await fetch(url);
        const el = document.getElementById('log-content');

        if (!res.ok) {
          el.innerHTML = '<span class="log-no-content">No log file available for this agent.</span>';
          return;
        }

        const text = await res.text();
        const agentStatus = res.headers.get('X-Agent-Status');
        const logSize = parseInt(res.headers.get('X-Log-Size') || '0', 10);

        // Skip update if log hasn't changed (same size)
        if (tailOnly && logSize === lastLogSize && logSize > 0) {
          // Still update streaming indicator
          const isActive = agentStatus === 'active' || agentStatus === 'idle';
          document.getElementById('log-streaming-indicator').style.display = isActive ? 'inline-block' : 'none';
          if (!isActive && logPollInterval) {
            clearInterval(logPollInterval);
            logPollInterval = null;
          }
          return;
        }
        lastLogSize = logSize;

        // Format the log content with stderr highlighting
        const formatted = escapeHtml(text)
          .split('\n')
          .map(line => {
            if (line.startsWith('[stderr]')) {
              return `<span class="stderr">${line}</span>`;
            }
            return line;
          })
          .join('\n');

        el.innerHTML = formatted || '<span class="log-no-content">Log file is empty.</span>';

        // Auto-scroll to bottom
        el.scrollTop = el.scrollHeight;

        // Update streaming indicator
        const isActive = agentStatus === 'active' || agentStatus === 'idle';
        document.getElementById('log-streaming-indicator').style.display = isActive ? 'inline-block' : 'none';

        // Stop polling if agent is no longer active
        if (!isActive && logPollInterval) {
          clearInterval(logPollInterval);
          logPollInterval = null;
        }
      } catch (e) {
        document.getElementById('log-content').innerHTML =
          '<span class="log-no-content">Error fetching log.</span>';
      }
    }

    // ─── Work items with tabs + detail ──────────────────────────────
    let currentWorkItems = [];
    let currentWorkTab = 'active';
    let selectedWorkId = null;

    async function fetchWork() {
      try {
        const res = await fetch(API + '/api/work?all=true');
        const data = await res.json();
        const items = data.items || [];
        // Change detection: skip re-render if data unchanged
        const json = JSON.stringify(items);
        if (json === lastWorkJson) return;
        lastWorkJson = json;
        currentWorkItems = items;
        renderWorkItems();
      } catch (e) {
        // Suppress transient errors when SSE is connected
        if (!sseConnected) {
          document.getElementById('work-container').innerHTML = '<span class="empty">Error loading work items.</span>';
        }
      }
    }

    function renderWorkItems() {
      const el = document.getElementById('work-container');
      const active = currentWorkItems.filter(w => w.status === 'available' || w.status === 'claimed' || w.status === 'blocked');
      const history = currentWorkItems.filter(w => w.status === 'completed');

      // Update tab counts
      document.getElementById('work-active-count').textContent = active.length;
      document.getElementById('work-history-count').textContent = history.length;

      const items = currentWorkTab === 'active' ? active : history;

      if (items.length === 0) {
        const msg = currentWorkTab === 'active' ? 'No active work items.' : 'No completed work items.';
        el.innerHTML = '<span class="empty">' + msg + '</span>';
        return;
      }

      if (currentWorkTab === 'active') {
        let html = '<table><tr><th>Title</th><th>Status</th><th>Priority</th><th>Claimed By</th><th>Created</th></tr>';
        for (const w of items) {
          const isSelected = w.item_id === selectedWorkId;
          html += '<tr class="work-row' + (isSelected ? ' selected' : '') + '" onclick="selectWork(\'' + escapeHtml(w.item_id) + '\')">'
            + '<td class="truncate">' + truncate(w.title, 40) + '</td>'
            + '<td>' + badge(w.status) + '</td>'
            + '<td>' + w.priority + '</td>'
            + '<td>' + (w.claimed_by ? truncate(w.claimed_by, 12) : '--') + '</td>'
            + '<td>' + relTime(w.created_at) + '</td>'
            + '</tr>';
        }
        html += '</table>';
        el.innerHTML = html;
      } else {
        // History: sort by completed_at DESC
        const sorted = [...items].sort((a, b) => new Date(b.completed_at || 0).getTime() - new Date(a.completed_at || 0).getTime());
        let html = '<table><tr><th>Title</th><th>Priority</th><th>Completed By</th><th>Completed</th><th>Duration</th></tr>';
        for (const w of sorted) {
          const isSelected = w.item_id === selectedWorkId;
          const duration = w.created_at && w.completed_at ? formatDuration(new Date(w.completed_at).getTime() - new Date(w.created_at).getTime()) : '--';
          html += '<tr class="work-row' + (isSelected ? ' selected' : '') + '" onclick="selectWork(\'' + escapeHtml(w.item_id) + '\')">'
            + '<td class="truncate">' + truncate(w.title, 40) + '</td>'
            + '<td>' + w.priority + '</td>'
            + '<td>' + (w.claimed_by ? truncate(w.claimed_by, 12) : '--') + '</td>'
            + '<td>' + (w.completed_at ? relTime(w.completed_at) : '--') + '</td>'
            + '<td>' + duration + '</td>'
            + '</tr>';
        }
        html += '</table>';
        el.innerHTML = html;
      }
    }

    function switchWorkTab(tab) {
      currentWorkTab = tab;
      document.querySelectorAll('.work-tab').forEach(t => t.classList.remove('active'));
      document.querySelector('.work-tab[onclick*="' + tab + '"]').classList.add('active');
      renderWorkItems();
    }

    function formatDuration(ms) {
      if (ms < 0) return '--';
      const s = Math.floor(ms / 1000);
      if (s < 60) return s + 's';
      const m = Math.floor(s / 60);
      if (m < 60) return m + 'm';
      const h = Math.floor(m / 60);
      const rm = m % 60;
      if (h < 24) return h + 'h ' + rm + 'm';
      const d = Math.floor(h / 24);
      return d + 'd ' + (h % 24) + 'h';
    }

    async function selectWork(itemId) {
      if (selectedWorkId === itemId) {
        closeWorkDetail();
        return;
      }

      selectedWorkId = itemId;
      document.getElementById('work-detail-panel').classList.add('visible');
      document.getElementById('work-detail-title').textContent = 'Loading...';
      document.getElementById('work-detail-body').innerHTML = '<span class="empty">Loading...</span>';

      // Re-render to show selection
      renderWorkItems();

      try {
        const res = await fetch(API + '/api/work/' + encodeURIComponent(itemId));
        const data = await res.json();

        if (!data.ok) {
          document.getElementById('work-detail-body').innerHTML = '<span class="empty">Work item not found.</span>';
          return;
        }

        const item = data.item;
        document.getElementById('work-detail-title').textContent = item.title;

        let html = '';

        // Meta info row
        html += '<div class="work-detail-meta">';
        html += '<div class="work-meta-item"><span class="work-meta-label">ID:</span><span class="work-meta-value">' + escapeHtml(item.item_id) + '</span></div>';
        html += '<div class="work-meta-item"><span class="work-meta-label">Status:</span>' + badge(item.status) + '</div>';
        html += '<div class="work-meta-item"><span class="work-meta-label">Priority:</span><span class="work-meta-value">' + item.priority + '</span></div>';
        html += '<div class="work-meta-item"><span class="work-meta-label">Source:</span><span class="work-meta-value">' + (item.source || '--') + '</span></div>';
        if (item.source_ref) {
          html += '<div class="work-meta-item"><span class="work-meta-label">Ref:</span><span class="work-meta-value">' + escapeHtml(item.source_ref) + '</span></div>';
        }
        if (item.project_id) {
          html += '<div class="work-meta-item"><span class="work-meta-label">Project:</span><span class="work-meta-value">' + escapeHtml(item.project_id) + '</span></div>';
        }
        html += '</div>';

        // Agent info with link
        if (item.claimed_by) {
          const agentName = data.agent_name || item.claimed_by.slice(0, 12);
          html += '<div class="work-detail-meta">';
          html += '<div class="work-meta-item"><span class="work-meta-label">' + (item.status === 'completed' ? 'Completed By:' : 'Claimed By:') + '</span>';
          html += '<span class="work-agent-link" onclick="navigateToAgent(\'' + escapeHtml(item.claimed_by) + '\')">' + escapeHtml(agentName) + '</span>';
          html += ' <span style="color:#484f58;font-size:10px">(' + truncate(item.claimed_by, 12) + ')</span></div>';
          if (item.claimed_at) {
            html += '<div class="work-meta-item"><span class="work-meta-label">Claimed:</span><span class="work-meta-value">' + relTime(item.claimed_at) + '</span></div>';
          }
          if (item.completed_at) {
            const duration = formatDuration(new Date(item.completed_at).getTime() - new Date(item.created_at).getTime());
            html += '<div class="work-meta-item"><span class="work-meta-label">Completed:</span><span class="work-meta-value">' + relTime(item.completed_at) + '</span><span class="duration-badge">' + duration + '</span></div>';
          }
          html += '</div>';
        }

        // Description
        if (item.description) {
          html += '<div class="work-detail-section-title">Description</div>';
          html += '<div class="work-detail-description">' + escapeHtml(item.description) + '</div>';
        }

        // Timeline
        const history = data.history || [];
        if (history.length > 0) {
          html += '<div class="work-detail-section-title">Timeline</div>';
          for (const ev of history) {
            html += '<div class="work-timeline-event">';
            html += '<span class="work-timeline-dot ' + escapeHtml(ev.event_type) + '"></span>';
            html += '<span style="color:#484f58;min-width:50px">' + relTime(ev.timestamp) + '</span>';
            html += '<span class="event-type">' + escapeHtml(ev.event_type) + '</span>';
            html += '<span class="event-summary">' + escapeHtml(ev.summary) + '</span>';
            html += '</div>';
          }
        }

        // Metadata
        if (item.metadata) {
          try {
            const meta = JSON.parse(item.metadata);
            html += '<div class="work-detail-section-title">Metadata</div>';
            html += '<div class="work-detail-metadata">' + escapeHtml(JSON.stringify(meta, null, 2)) + '</div>';
          } catch {}
        }

        document.getElementById('work-detail-body').innerHTML = html;
      } catch (e) {
        document.getElementById('work-detail-body').innerHTML = '<span class="empty">Error loading work item detail.</span>';
      }
    }

    function closeWorkDetail() {
      selectedWorkId = null;
      document.getElementById('work-detail-panel').classList.remove('visible');
      renderWorkItems();
    }

    function navigateToAgent(sessionId) {
      // Switch to agent log viewer
      selectAgent(sessionId);
      // Scroll to agents section
      document.getElementById('agents-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Events: deduplicated by ID, merged from SSE + polling
    const MAX_EVENT_LINES = 30;
    let eventMap = new Map(); // id -> event object

    function renderEvents() {
      const el = document.getElementById('events-container');
      if (eventMap.size === 0) {
        el.innerHTML = '<span class="empty">No recent events.</span>';
        return;
      }
      const sorted = [...eventMap.values()].sort((a, b) => b.id - a.id).slice(0, MAX_EVENT_LINES);
      el.innerHTML = sorted.map(e => {
        const actor = e.actor_id ? e.actor_id.slice(0, 12) : 'system';
        return `<div class="event-line">
          <span style="color:#484f58">${relTime(e.timestamp)}</span>
          <span class="event-type">${e.event_type}</span>
          [${actor}]
          <span class="event-summary">${e.summary}</span>
        </div>`;
      }).join('');
    }

    function addEvent(e) {
      if (!e.id) return;
      eventMap.set(e.id, e);
      // Prune oldest if map grows too large
      if (eventMap.size > MAX_EVENT_LINES * 2) {
        const ids = [...eventMap.keys()].sort((a, b) => a - b);
        for (let i = 0; i < ids.length - MAX_EVENT_LINES; i++) {
          eventMap.delete(ids[i]);
        }
      }
    }

    function connectSSE() {
      try {
        const es = new EventSource(API + '/api/events/stream');
        es.onmessage = (msg) => {
          try {
            const data = JSON.parse(msg.data);
            if (data.type === 'connected') {
              sseConnected = true;
              adjustPolling();
              return;
            }
            addEvent(data);
            renderEvents();
          } catch {}
        };
        es.onerror = () => {
          sseConnected = false;
          adjustPolling();
          es.close();
          setTimeout(connectSSE, 5000);
        };
      } catch {}
    }

    function adjustPolling() {
      const interval = sseConnected ? POLL_SLOW : POLL_FAST;
      if (pollInterval) clearInterval(pollInterval);
      pollInterval = setInterval(refresh, interval);
      const modeEl = document.getElementById('poll-mode');
      if (modeEl) modeEl.textContent = sseConnected ? 'via SSE + poll every 30s' : 'every 5s';
    }

    async function fetchEvents() {
      try {
        const res = await fetch(API + '/api/events?limit=30');
        const data = await res.json();
        if (!data.items || data.items.length === 0) return;
        for (const e of data.items) { addEvent(e); }
        renderEvents();
      } catch {}
    }

    // ─── Project list and detail ──────────────────────────────────

    let selectedProjectId = null;
    let projectsNeedRender = false;

    async function fetchProjects() {
      try {
        const res = await fetch(API + '/api/projects');
        const data = await res.json();
        const projects = data.items || [];

        // Change detection: skip re-render if data unchanged (ignore selection state)
        const json = JSON.stringify(projects);
        if (json === lastProjectsJson && !projectsNeedRender) return;
        lastProjectsJson = json;
        projectsNeedRender = false;

        const el = document.getElementById('projects-container');

        if (projects.length === 0) {
          el.innerHTML = '<span class="empty">No projects registered.</span>';
          return;
        }

        let html = '<div class="project-grid">';
        for (const p of projects) {
          const isSelected = p.project_id === selectedProjectId;
          const totalWork = (p.work_available || 0) + (p.work_claimed || 0) + (p.work_completed || 0) + (p.work_blocked || 0);
          const lastAct = p.last_activity ? relTime(p.last_activity) : 'never';

          html += `<div class="project-card${isSelected ? ' selected' : ''}" onclick="selectProject('${escapeHtml(p.project_id)}')">
            <div class="project-card-header">
              <span class="project-card-name">${escapeHtml(p.display_name)}</span>
              <span class="project-card-id">${escapeHtml(p.project_id)}</span>
            </div>
            <div class="project-card-stats">
              ${p.active_agents > 0 ? `<span class="stat"><span class="dot dot-active"></span>${p.active_agents} agent${p.active_agents !== 1 ? 's' : ''}</span>` : ''}
              ${p.work_available > 0 ? `<span class="stat"><span class="dot dot-available"></span>${p.work_available} avail</span>` : ''}
              ${p.work_claimed > 0 ? `<span class="stat"><span class="dot dot-claimed"></span>${p.work_claimed} claimed</span>` : ''}
              ${p.work_completed > 0 ? `<span class="stat"><span class="dot dot-completed"></span>${p.work_completed} done</span>` : ''}
              ${p.work_blocked > 0 ? `<span class="stat"><span class="dot dot-blocked"></span>${p.work_blocked} blocked</span>` : ''}
              ${totalWork === 0 && p.active_agents === 0 ? '<span class="stat" style="color:#484f58">no activity</span>' : ''}
            </div>
            <div class="project-card-meta">
              ${p.remote_repo ? `<a href="${escapeHtml(p.remote_repo)}" target="_blank" onclick="event.stopPropagation()">repo</a> · ` : ''}
              ${lastAct !== 'never' ? lastAct : 'registered ' + relTime(p.registered_at)}
            </div>
          </div>`;
        }
        html += '</div>';
        el.innerHTML = html;
      } catch (e) {
        // Suppress transient errors when SSE is connected
        if (!sseConnected) {
          document.getElementById('projects-container').innerHTML = '<span class="empty">Error loading projects.</span>';
        }
      }
    }

    async function selectProject(projectId) {
      if (selectedProjectId === projectId) {
        closeProjectDetail();
        return;
      }

      selectedProjectId = projectId;
      document.getElementById('project-detail').classList.add('visible');
      document.getElementById('project-detail-name').textContent = projectId;
      document.getElementById('project-detail-stats').innerHTML = '<span class="empty">Loading...</span>';

      // Re-render project list to show selection
      projectsNeedRender = true;
      fetchProjects();

      try {
        const res = await fetch(API + '/api/projects/' + encodeURIComponent(projectId));
        const data = await res.json();

        if (!data.ok) {
          document.getElementById('project-detail-stats').innerHTML = '<span class="empty">Project not found.</span>';
          return;
        }

        document.getElementById('project-detail-name').textContent = data.project.display_name;

        // Stats bar
        const s = data.stats;
        document.getElementById('project-detail-stats').innerHTML = `
          <div class="project-stat-box">
            <div class="project-stat-number">${s.active_agents}</div>
            <div class="project-stat-label">Active Agents</div>
          </div>
          <div class="project-stat-box">
            <div class="project-stat-number">${s.total_work}</div>
            <div class="project-stat-label">Work Items</div>
          </div>
          <div class="project-stat-box">
            <div class="project-stat-number rate">${s.completion_rate}%</div>
            <div class="project-stat-label">Completion</div>
            <div class="completion-bar" style="width:80px"><div class="completion-bar-fill" style="width:${s.completion_rate}%"></div></div>
          </div>
          <div class="project-stat-box">
            <div class="project-stat-number">${s.total_agents}</div>
            <div class="project-stat-label">Total Agents</div>
          </div>
          <div class="project-stat-box">
            <div class="project-stat-label" style="font-size:11px;text-transform:none">${s.last_activity ? relTime(s.last_activity) : 'no activity'}</div>
            <div class="project-stat-label">Last Activity</div>
          </div>
        `;

        // Agents tab
        const agents = data.agents || [];
        if (agents.length === 0) {
          document.getElementById('project-tab-agents').innerHTML = '<span class="empty">No agents for this project.</span>';
        } else {
          let ahtml = '<table><tr><th>Name</th><th>Status</th><th>Work</th><th>Last Seen</th><th>Started</th></tr>';
          for (const a of agents) {
            ahtml += `<tr>
              <td>${escapeHtml(a.agent_name)}</td>
              <td>${badge(a.status)}</td>
              <td class="truncate">${truncate(a.current_work, 35)}</td>
              <td>${relTime(a.last_seen_at)}</td>
              <td>${relTime(a.started_at)}</td>
            </tr>`;
          }
          ahtml += '</table>';
          document.getElementById('project-tab-agents').innerHTML = ahtml;
        }

        // Work items tab
        const work = data.work_items || [];
        if (work.length === 0) {
          document.getElementById('project-tab-work').innerHTML = '<span class="empty">No work items for this project.</span>';
        } else {
          let whtml = '<table><tr><th>ID</th><th>Title</th><th>Status</th><th>Priority</th><th>Claimed</th><th>Created</th></tr>';
          for (const w of work) {
            whtml += `<tr>
              <td>${escapeHtml(w.item_id)}</td>
              <td class="truncate">${truncate(w.title, 30)}</td>
              <td>${badge(w.status)}</td>
              <td>${w.priority}</td>
              <td>${w.claimed_by ? truncate(w.claimed_by, 12) : '--'}</td>
              <td>${relTime(w.created_at)}</td>
            </tr>`;
          }
          whtml += '</table>';
          document.getElementById('project-tab-work').innerHTML = whtml;
        }

        // Events tab
        const events = data.events || [];
        if (events.length === 0) {
          document.getElementById('project-tab-events').innerHTML = '<span class="empty">No events for this project.</span>';
        } else {
          document.getElementById('project-tab-events').innerHTML = events.slice(0, 30).map(e => {
            const actor = e.actor_id ? e.actor_id.slice(0, 12) : 'system';
            return `<div class="event-line">
              <span style="color:#484f58">${relTime(e.timestamp)}</span>
              <span class="event-type">${escapeHtml(e.event_type)}</span>
              [${escapeHtml(actor)}]
              <span class="event-summary">${escapeHtml(e.summary)}</span>
            </div>`;
          }).join('');
        }

        // Default to agents tab
        switchProjectTab('agents');

      } catch (e) {
        document.getElementById('project-detail-stats').innerHTML = '<span class="empty">Error loading project detail.</span>';
      }
    }

    function closeProjectDetail() {
      selectedProjectId = null;
      document.getElementById('project-detail').classList.remove('visible');
      projectsNeedRender = true;
      fetchProjects();
    }

    function switchProjectTab(tab) {
      document.querySelectorAll('.project-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.project-tab-content').forEach(t => t.classList.remove('active'));
      document.querySelector(`.project-tab[onclick*="${tab}"]`).classList.add('active');
      document.getElementById('project-tab-' + tab).classList.add('active');
    }

    async function refresh() {
      await Promise.all([fetchStatus(), fetchProjects(), fetchAgents(), fetchWork(), fetchEvents()]);
      document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
    }

    refresh();
    connectSSE();
    pollInterval = setInterval(refresh, POLL_FAST);
  </script>
</body>
</html>
